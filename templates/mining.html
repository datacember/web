<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Froth Flotation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="/static/mining_files/libs/clipboard/clipboard.min.js"></script>
<script src="/static/mining_files/libs/quarto-html/quarto.js"></script>
<script src="/static/mining_files/libs/quarto-html/popper.min.js"></script>
<script src="/static/mining_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="/static/mining_files/libs/quarto-html/anchor.min.js"></script>
<link href="/static/mining_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="/static/mining_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="/static/mining_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="/static/mining_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="/static/mining_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav style="padding-top: 3vh; id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-is-froth-flotation" id="toc-what-is-froth-flotation" class="nav-link active" data-scroll-target="#what-is-froth-flotation"><span class="header-section-number">1</span> What is Froth Flotation?</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">2</span> Dataset</a></li>
  <li><a href="#your-task" id="toc-your-task" class="nav-link" data-scroll-target="#your-task"><span class="header-section-number">3</span> Your Task</a>
  <ul class="collapse">
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda"><span class="header-section-number">3.1</span> EDA</a></li>
  <li><a href="#operational-reporting" id="toc-operational-reporting" class="nav-link" data-scroll-target="#operational-reporting"><span class="header-section-number">3.2</span> Operational Reporting</a></li>
  <li><a href="#modelling" id="toc-modelling" class="nav-link" data-scroll-target="#modelling"><span class="header-section-number">3.3</span> Modelling</a></li>
  <li><a href="#wildcard" id="toc-wildcard" class="nav-link" data-scroll-target="#wildcard"><span class="header-section-number">3.4</span> Wildcard</a></li>
  </ul></li>
  <li><a href="#modelling-considerations" id="toc-modelling-considerations" class="nav-link" data-scroll-target="#modelling-considerations"><span class="header-section-number">4</span> Modelling: Considerations</a></li>
  </ul>
</nav>
</div>
<header 
style="display: flex; flex-direction: row; justify-content: center;
		max-width: 100vw; width: 100vw;
		margin: none; z-index: 3; position: fixed;
		padding: 1vh;"
>
	<p id="logo-med"
style="letter-spacing: -0.07em; font-size: 2em; width: 75vw; max-width: 75vw; justify-self: left; font-family: 'Libre Baskerville', Serif;"
	>
		<a href="/" style="text-decoration: none; color: black;">
		Datacember
		</a>
	</p>
	<p id="users-name"
	style="font-family: 'Source Sans 3', serif;"
	>Hello {{name}} | {{points}} pts | </p>
	<p
	style="font-family: 'Source Sans 3', serif;"
	><a href="/logout">Sign Out</a></p>
</header>
<main style="padding-top: 6vh;"  class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Froth Flotation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="what-is-froth-flotation" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="what-is-froth-flotation"><span class="header-section-number">1</span> What is Froth Flotation?</h2>
<div class="columns">
<div class="column" style="width:60%;">
<p>Amina, Gangue and Slurry––are all part of the jargon that make the froth flotation process confusing. However this process has been instrumental in shaping the 20th century. At its core froth flotation is just a technique whereby minerals can be separated from waste material (gangue or tailings), making it an important process in extracting minerals and mineral purification.</p>
<p>Under the hood, froth flotation works by combining minerals in an aqueous slurry. Mineral samples are hydrophillic (iron oxide included) but through the introduction of a specialist reagent (amina or amine in our data) this mineral selectively becomes hydrophobic. These now hydrophobic minerals repel water, and with the addition of air and frother, they attract to the air bubbles and float to the top of the plant, at which point the mineral has been separated from the gangue (Silica in our data).</p>
<p>Naturally, much of the froth flotation process is underpinned by chemistry. Video aides are available <a href="https://www.youtube.com/watch?v=LGXqyNwSUIQ"> here</a></p>
</div><div class="column" style="width:40%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/static/images/cell.png" title="Flotation Cell" class="img-fluid figure-img"></p>
<figcaption>Diagram of a Flotation Cell Taken from <a href="https://en.wikipedia.org/wiki/Froth_flotation"> wikepedia </a></figcaption>
</figure>
</div>
</div>
</div>
<p>For this challenge, you are working with a <strong>time series</strong> dataset of froth flotation data.</p>
</section>
<section id="dataset" class="level2 page-columns page-full" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="dataset"><span class="header-section-number">2</span> Dataset</h2>
<p>The dataset can be found <a href="https://www.kaggle.com/datasets/edumagalhaes/quality-prediction-in-a-mining-process?resource=download">here</a>.</p>
<div class="column-body-outset">
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 18%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Column Name</strong></th>
<th><strong>Unit</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Date</td>
<td>YYYY-MM-DD</td>
<td>The date of the recorded data.</td>
</tr>
<tr class="even">
<td>% Iron Feed</td>
<td>%</td>
<td>Percentage of iron in the feed material.</td>
</tr>
<tr class="odd">
<td>% Silica Feed</td>
<td>%</td>
<td>Percentage of silica in the feed material.</td>
</tr>
<tr class="even">
<td>Starch Flow</td>
<td>kg/h</td>
<td>Flow rate of starch used in the process.</td>
</tr>
<tr class="odd">
<td>Amina Flow</td>
<td>L/h</td>
<td>Flow rate of amina used in the process.</td>
</tr>
<tr class="even">
<td>Ore Pulp Flow</td>
<td>m³/h</td>
<td>Flow rate of ore pulp through the system.</td>
</tr>
<tr class="odd">
<td>Ore Pulp pH</td>
<td>-</td>
<td>pH level of the ore pulp.</td>
</tr>
<tr class="even">
<td>Ore Pulp Density</td>
<td>kg/m³</td>
<td>Density of the ore pulp.</td>
</tr>
<tr class="odd">
<td>Flotation Column 01 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 01.</td>
</tr>
<tr class="even">
<td>Flotation Column 02 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 02.</td>
</tr>
<tr class="odd">
<td>Flotation Column 03 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 03.</td>
</tr>
<tr class="even">
<td>Flotation Column 04 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 04.</td>
</tr>
<tr class="odd">
<td>Flotation Column 05 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 05.</td>
</tr>
<tr class="even">
<td>Flotation Column 06 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 06.</td>
</tr>
<tr class="odd">
<td>Flotation Column 07 Air Flow</td>
<td>m³/min</td>
<td>Air flow rate in flotation column 07.</td>
</tr>
<tr class="even">
<td>Flotation Column 01 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 01.</td>
</tr>
<tr class="odd">
<td>Flotation Column 02 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 02.</td>
</tr>
<tr class="even">
<td>Flotation Column 03 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 03.</td>
</tr>
<tr class="odd">
<td>Flotation Column 04 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 04.</td>
</tr>
<tr class="even">
<td>Flotation Column 05 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 05.</td>
</tr>
<tr class="odd">
<td>Flotation Column 06 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 06.</td>
</tr>
<tr class="even">
<td>Flotation Column 07 Level</td>
<td>cm</td>
<td>Pulp level in flotation column 07.</td>
</tr>
<tr class="odd">
<td>% Iron Concentrate</td>
<td>%</td>
<td>Percentage of iron in the concentrate material.</td>
</tr>
<tr class="even">
<td>% Silica Concentrate</td>
<td>%</td>
<td>Percentage of silica in the concentrate material.</td>
</tr>
</tbody>
</table>
</div>
<p>Some features are updated on an hourly basis, and others on a 20 second basis, finding which are which will be left as an excersise to the reader.</p>
</section>
<section id="your-task" class="level2 page-columns page-full" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="your-task"><span class="header-section-number">3</span> Your Task</h2>
<p>Below are a few directions in which you can explore the data. As always, refer to the report writing guide</p>
<section id="eda" class="level3 page-columns page-full" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="eda"><span class="header-section-number">3.1</span> EDA</h3>
<p>If the froth flotation jargon is a bit too much, try importing the data with python or excel and try producing some simple data summaries. Maybe try producing a time series plot to demonstrate how the most ‘infuential’ factors determine silica concentrate</p>
<p>Here are some leading discussion questions:</p>
<ul>
<li><p>What kinds of trends or associations did you notice within your data summaries?</p></li>
<li><p>Did you notice any outliers?</p></li>
<li><p>What factors were most pertinent or ‘influential’ in predicting Silica Concentrate?</p></li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<p>What kinds of statistics or plots show this? Hint: Check correlation plots and correlation</p>
</div></div><ul>
<li>What are the impacts of this data? Can any of your conclusions save money for the process operator?</li>
</ul>
</section>
<section id="operational-reporting" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="operational-reporting"><span class="header-section-number">3.2</span> Operational Reporting</h3>
<p>How has the froth flotation plant been performing? Summarise the performance of the process, and if you find any rooms for improvment write them up into an executive summary</p>
<p>Leading questions</p>
<ul>
<li><p>What metric did you use for plant performance?</p></li>
<li><p>How does the plant perform each month by this metric?</p></li>
<li><p>What reccoemndatiosn do you have for the plant operator?</p></li>
</ul>
</section>
<section id="modelling" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="modelling"><span class="header-section-number">3.3</span> Modelling</h3>
<p>As aformentioned, with a predictive model Engineers could anticipate changes to silica concentrate, and take proactive measures to reduce uneccesary waste of iron concentrate in tailings. Try produce a model to predict Silica Concentrate.</p>
<p>Here are some leading discussion questions for your report:</p>
<ul>
<li><p>What kind of model did you select? Did it take advantage of the time series data?</p></li>
<li><p>Evaluate your models performance. What kinds of statistics did you use?</p></li>
<li><p>Comment on any limitations with your methodology, data or approach you took.</p></li>
</ul>
<p>If you choose a modelling approach refer to the next section for additional modelling considerations</p>
</section>
<section id="wildcard" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="wildcard"><span class="header-section-number">3.4</span> Wildcard</h3>
<p>Or any other ideas you’d like to explore. Additional points for innovative tasks!</p>
<p>Additionally, for submissions you may want to partner with another member of the challenge to contrast a regression vs a LSTM modelling approach for instance.</p>
</section>
</section>
<section id="modelling-considerations" class="level2 page-columns page-full" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="modelling-considerations"><span class="header-section-number">4</span> Modelling: Considerations</h2>
<p>The goal is to predict how much impurity is in the ore concentrate for the next hour interval. Impurity in this case is the ‘% of Silica’ measurment.</p>
<p>Using this model, an engineer could take corrective action in advance and reduce the impurity.</p>
<p>Here are a few model selections to consider.</p>
<ul>
<li><p>Columns 4 to 8 are meaures that are most “important” to predicting final quality.</p></li>
<li><p>Columns 9 to 22 are process data.</p></li>
<li><p>The final two are lab measurements</p></li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<p>While variable selection is at your descresion for modelling tasks, keep in mind that the last two columns % Iron Concentrate and % Silica Concentrate are likely not available in a practical setting.</p>
</div></div><p>You may also want to remove date as a feature to prevent overfitting.</p>
</section>

</main>			<footer style="
background-color: rgb(33, 33, 33);
width: 100vw;
maxwidth: 100vw;
color: white;
display: flex;
margin-top: 5vh;
padding-top: 5vh;
padding-bottom: 5vh;
justify-content: space-evenly;
position: relative; /* Positioning context for any additional tweaks */
left: 50%; /* Move the footer to the middle */
transform: translateX(-45%);
				">

				<style>html{padding:0;margin:0;}</style>

				<div class="col">
					<div class='logo' style="letter-spacing: -0.07em; font-size: 2em; font-family: 'Libre Baskerville', serif;">
						Datacember	
					</div>
					<br>
					<p style="font-size: 0.8em;"><i>A Datascience December Challenge</i></p>
				</div>

				<div class="col" style="display:block; line-height: 1vh;">
					<p class="footer-title" style="font-size: 1.25em; letter-spacing: -0.07; font-family: 'Libre Baskerville', serif;">DataScience</p>
					<hr style="color: white;">
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="
						https://pkgs.rstudio.com/rticles/articles/rticles.html
						">rticles templates</a></p>
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="
						https://flax.readthedocs.io/en/latest/
						">Flax - ML library</a></p>
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="https://r4ds.hadley.nz">R for Data Science</a></p>
				</div>

				<div class="col" style="display:block; line-height: 1vh;">
					<p class="footer-title" style="font-size: 1.25em; letter-spacing: -0.07; font-family: 'Libre Baskerville', serif;">Developer</p>
					<hr style="color: white;">
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="https://github.com/datacember/web">website source code</a></p>
				</div>

				<div class="col" style="display:block; line-height: 1vh;">
					<p class="footer-title" style="font-size: 1.25em; letter-spacing: -0.07; font-family: 'Libre Baskerville', serif;">Other</p>
					<hr style="color: white;">
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="/guide/privacy">privacy</a></p>
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="/guide/privacy">privacy</a></p>
					<p><a style="color: white; text-decoration: none; font-size:0.8em;" href="/guide/thanks">Thanks!</a></p>
					<p style="font-size:0.8em;">contact:</p>
					<p style="font-size:0.8em;">alexanderjwells04@gmail.com</p>
				</div>


			</footer>


<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>